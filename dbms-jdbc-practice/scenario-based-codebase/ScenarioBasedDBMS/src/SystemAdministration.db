/* 6. System Administration
UC-6.1: Manage Specialty Lookup
Actor: Administrator
Flow: CRUD operations on specialties reference table. Check foreign key constraints before DELETE using COUNT subquery.

UC-6.2: Database Backup Trigger
Actor: System (Scheduled)
Flow: Execute JDBC batch operations to export critical tables. Use DatabaseMetaData to retrieve schema information for backup validation.

UC-6.3: View System Audit Logs
Actor: Administrator
Flow: Query audit_log table populated via database triggers on INSERT/UPDATE/DELETE. Filter by user, table_name, timestamp using complex WHERE conditions.
*/


--------------------------------------------------------------------------------------------------------------

CREATE TABLE IF NOT EXISTS specialties (
    ->     specialty_id INT PRIMARY KEY AUTO_INCREMENT,
    ->     specialty_name VARCHAR(100) UNIQUE NOT NULL
    -> );
Query OK, 0 rows affected (0.08 sec)

mysql> INSERT INTO specialties (specialty_name)
    -> VALUES ('Cardiology'), ('Neurology'), ('Orthopedics');
Query OK, 3 rows affected (0.01 sec)
Records: 3  Duplicates: 0  Warnings: 0

)

mysql> SELECT * FROM specialties;
+--------------+----------------+
| specialty_id | specialty_name |
+--------------+----------------+
|            1 | Cardiology     |
|            2 | Neurology      |
|            3 | Orthopedics    |
+--------------+----------------+
3 rows in set (0.00 sec)

mysql> UPDATE specialties
    -> SET specialty_name = 'General Medicine'
    -> WHERE specialty_id = 1;
Query OK, 1 row affected (0.01 sec)
Rows matched: 1  Changed: 1  Warnings: 0

mysql> SELECT COUNT(*) AS doctors_using_specialty
    -> FROM doctors
    -> WHERE specialization = 'Cardiology';
+-------------------------+
| doctors_using_specialty |
+-------------------------+
|                       1 |
+-------------------------+
1 row in set (0.02 sec)

mysql> DELETE FROM specialties
    -> WHERE specialty_name = 'Cardiology';
Query OK, 0 rows affected (0.00 sec



--------------------------------------------------------------------------------------------------------------


 SELECT table_name
    -> FROM information_schema.tables
    -> WHERE table_schema = DATABASE()
    -> AND table_name IN ('patients','doctors','appointments','visits','bills');
+--------------+
| TABLE_NAME   |
+--------------+
| appointments |
| bills        |
| doctors      |
| patients     |
| visits       |
+--------------+
5 rows in set (0.00 sec)

mysql> SELECT
    ->     (SELECT COUNT(*) FROM patients) AS patients_count,
    ->     (SELECT COUNT(*) FROM doctors) AS doctors_count,
    ->     (SELECT COUNT(*) FROM appointments) AS appointments_count,
    ->     (SELECT COUNT(*) FROM visits) AS visits_count,
    ->     (SELECT COUNT(*) FROM bills) AS bills_count;
+----------------+---------------+--------------------+--------------+-------------+
| patients_count | doctors_count | appointments_count | visits_count | bills_count |
+----------------+---------------+--------------------+--------------+-------------+
|              3 |             2 |                  2 |            2 |           1 |
+----------------+---------------+--------------------+--------------+-------------+
1 row in set (0.04 sec)


---------------------------------------------------------------------------------------------------------------


mysql> CREATE TABLE IF NOT EXISTS audit_log (
    ->     log_id INT PRIMARY KEY AUTO_INCREMENT,
    ->     table_name VARCHAR(50),
    ->     action_type VARCHAR(20),
    ->     record_id INT,
    ->     action_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    -> );
Query OK, 0 rows affected (0.01 sec)

mysql> CREATE TRIGGER trg_patient_insert
    -> AFTER INSERT ON patients
    -> FOR EACH ROW
    -> INSERT INTO audit_log (table_name, action_type, record_id)
    -> VALUES ('patients', 'INSERT', NEW.patient_id);
Query OK, 0 rows affected (0.01 sec)

mysql> CREATE TRIGGER trg_patient_update
    -> AFTER UPDATE ON patients
    -> FOR EACH ROW
    -> INSERT INTO audit_log (table_name, action_type, record_id)
    -> VALUES ('patients', 'UPDATE', NEW.patient_id);
Query OK, 0 rows affected (0.01 sec)

mysql> CREATE TRIGGER trg_patient_delete
    -> AFTER DELETE ON patients
    -> FOR EACH ROW
    -> INSERT INTO audit_log (table_name, action_type, record_id)
    -> VALUES ('patients', 'DELETE', OLD.patient_id);
Query OK, 0 rows affected (0.01 sec)

mysql> SELECT *
    -> FROM audit_log
    -> WHERE table_name = 'patients'
    -> AND action_time BETWEEN '2026-02-01' AND '2026-02-28'
    -> ORDER BY action_time DESC;
Empty set (0.00 sec)

mysql> SELECT action_type, COUNT(*) AS total_actions
    -> FROM audit_log
    -> GROUP BY action_type;
Empty set (0.00 sec)

mysql> INSERT INTO patients (name, dob, phone, email, address, blood_group)
    -> VALUES ('Test User', '2000-01-01', '9999999999', 'test@mail.com', 'Bhopal', 'O+');
Query OK, 1 row affected (0.01 sec)

mysql> SELECT * FROM audit_log ORDER BY action_time DESC;
+--------+------------+-------------+-----------+---------------------+
| log_id | table_name | action_type | record_id | action_time         |
+--------+------------+-------------+-----------+---------------------+
|      1 | patients   | INSERT      |        16 | 2026-02-17 15:53:27 |
+--------+------------+-------------+-----------+---------------------+
1 row in set (0.00 sec)

mysql>

